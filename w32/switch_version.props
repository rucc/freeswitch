<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ImportGroup Label="PropertySheets">
    <Import Project="basedir.props" Condition=" '$(BaseDirImported)' == ''"/>
  </ImportGroup>

  <PropertyGroup>
    <switch_versionPropsImported>true</switch_versionPropsImported>
  </PropertyGroup>

  <UsingTask TaskName="SwitchVersionTask" 
             TaskFactory="CodeTaskFactory"  
             AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
             <Task>  
                <Reference Include="Microsoft.Build" />
                <Reference Include="Microsoft.Build.Framework" />
                <Code Type="Class" Language="cs">
<![CDATA[  
using System;
using System.IO;
using System.Collections.Generic;
using System.Text.RegularExpressions;
using Microsoft.Build.Framework;
using System.Diagnostics;

    public class SwitchVersionTask : Microsoft.Build.Utilities.Task
    {
        private string basedir;
        private string TemplatePath;
        private string DestinationPath;

		private static string sys(string cmd, string args, string stdIn, out string err)
        {
            err = null;
            using (Process p = new Process())
            {
                p.StartInfo.RedirectStandardInput = true;
                p.StartInfo.UseShellExecute = false;
                p.StartInfo.RedirectStandardOutput = true;
                p.StartInfo.RedirectStandardError = true;
                p.StartInfo.FileName = cmd;
                p.StartInfo.Arguments = args;
                p.Start();
                p.StandardInput.Write(stdIn);
                p.StandardInput.Close();
                string output = p.StandardOutput.ReadToEnd();
                err = p.StandardError.ReadToEnd();
                p.WaitForExit();
                return output;
            }
        }

        public override bool Execute()
        {
            basedir = Path.GetFullPath(@"$(BaseDir)");

            Log.LogMessage(MessageImportance.High,
                  "Parsing FreeSWITCH version.");
            string err;
            string revision = sys("git", @"-C """ + basedir.Substring(0, basedir.Length-1) + @""" rev-parse --short HEAD", null, out err);
            if (!string.IsNullOrWhiteSpace(err))
            {
                    revision = "";
            }
            else
            {
                    revision = revision.Trim();
            }

            string ConfigureAC = File.ReadAllText(@"$(BaseDir)configure.ac");                
            string pattern = @"AC_SUBST\((SWITCH_VERSION_[A-Z_]+),.*\[(.*)\]\)";

            Dictionary<string, string> v = new Dictionary<string, string>();

            string year = DateTime.UtcNow.Year.ToString();
            v.Add("SWITCH_VERSION_YEAR", year);
            
            foreach (Match m in Regex.Matches(ConfigureAC, pattern)) {
               string value = m.Groups[2].Value.Trim();
               if (value.Contains("-")) {
                   string[] tokens = value.Split('-');
                   value = tokens[0];
               }        
               var name = m.Groups[1].Value.Trim();
               value = value.Trim();
               if (name.StartsWith("SWITCH_VERSION_REVISION") && string.IsNullOrWhiteSpace(value))
               {
                   value = revision;
               }
               v.Add(name, value);
               Log.LogMessage(MessageImportance.High, name + " = '" + value + "'");
            }
            
            //---------------------------------------------------------            
            Log.LogMessage(MessageImportance.High,
                "Generating switch_version.h");            
                
            TemplatePath = basedir + @"src\include\switch_version.h.template";
            DestinationPath = basedir + @"src\include\switch_version.h";
            
            string template = File.ReadAllText(TemplatePath);
            foreach (var version_bit in v) {
                template = template.Replace("@" + version_bit.Key + "@", version_bit.Value);
            }            
                       
            File.WriteAllText(DestinationPath, template);            
            
            //---------------------------------------------------------
            Log.LogMessage(MessageImportance.High,
                "Generating switch_version.inc");                    
            
            TemplatePath = @"$(ProjectDir)\switch_version.inc.template";
            DestinationPath = @"$(ProjectDir)\switch_version.inc";            

            template = File.ReadAllText(TemplatePath);
            foreach (var version_bit in v) {
                template = template.Replace("@" + version_bit.Key + "@", version_bit.Value);
            }
                                                           
            File.WriteAllText(DestinationPath, template);
            
            //---------------------------------------------------------

            return true;
        }
    }
]]>  
                </Code>  
             </Task>  
  </UsingTask>  

  <Target Name="SwitchVersionTarget" BeforeTargets="CustomBuild;Build">  
      <SwitchVersionTask>         
      </SwitchVersionTask>         
  </Target> 

</Project>
